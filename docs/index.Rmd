---
title: "Assessment research question: Is there a relationship between antidepressant prescriptions and SIMD deprivation level in Scotland’s major cities (Glasgow, Edinburgh, Dundee and Aberdeen)?"
output: html_document
date: "2025-10-31"
---


Research Question: "Is there a relationship between antidepressant prescriptions and SIMD deprivation level in Scotland’s major cities (Glasgow, Edinburgh, Dundee and Aberdeen)?" 

```{r}
#merge 12 "Data by Prescriber Locations" files (August 2024 - July 2025) into one single file and only keeps columns & drug type (antidepressants) relative to the research question. 
library(tidyverse)
library(dplyr)

file_list <- list.files(path = here::here("data"),
                        pattern = "^2024|2025",
                        full.names = TRUE)

combined_PrescriberData <- map_dfr(file_list, ~read.csv(.x)  %>%
                                    select(HBT, GPPractice, BNFItemCode, PaidDateMonth)) %>% 
                                    filter(str_detect(BNFItemCode, "^04030[1-4]"))

sum(is.na(combined_PrescriberData)) ##for check

#combine with the "GP Practice List and Sizes July 2025" file
GPPractice_location <- read_csv(here::here("data", "GPLocation.csv")) %>% 
  select(PracticeCode, PracticeListSize, HB, DataZone) 
 
GPPracticeLocation_with_CombinedPrescriber <- combined_PrescriberData %>% 
  left_join(GPPractice_location, by = c("GPPractice" = "PracticeCode"))


#combine with the most up-to-date version of SIMD file (SIMD2020v2)
SIMD <- read_csv(here::here("data", "SIMD2020v2.csv")) %>% 
  select(DataZone, HB, CA, SIMD2020V2Rank, SIMD2020V2CADecile, SIMD2020V2CAQuintile)

GPPracticeLocation_CombinedPrescriber_SIMD <- GPPracticeLocation_with_CombinedPrescriber %>% 
  left_join(SIMD, by = c("DataZone" = "DataZone", "HB" = "HB")) %>% 
   filter(CA %in% c("S12000036", "S12000033", "S12000042", "S12000049")) ##NAs (owing to the temporal mismatch between the datasets, ie.: Data by prescriber location --> collected monthly; GP practice list sizes --> collected seasonally) are automatically excluded by this step. 


#combine with the most up-to-date "Data Zone (2011) Population Estimates"
PopulationEstimates <- read_csv(here::here("data", "PopulationEstimate.csv"))%>% 
  select(DataZone, Year, Sex, TotalPopulation = AllAges) %>% 
  filter(Year == 2022, Sex == "All") %>% 
  select(-Year, -Sex)

GPPracticeLocation_CombinedPrescriber_SIMD_Population <- GPPracticeLocation_CombinedPrescriber_SIMD %>% 
  left_join(PopulationEstimates, by = c("DataZone" = "DataZone"))
``` 



```{r}

#counts how many antidepressant prescriptions each GP practice issued, extracts the practice characteristics that should be the same for all prescriptions from the same practice, and calculates the prescribing rate of antidepressant prescriptions per 1000 patients based on each practice's registered patient population (PracticeListSize). 
##grouping the data at the GP practice level accounts for considering the fact that patients may live outside the GP practice's local data zone, thereby ensuring prescribing rates more accurately reflect each GP practice's actual workload. 
TotalPrescriptions_byGP <- GPPracticeLocation_CombinedPrescriber_SIMD_Population %>%
  group_by(GPPractice) %>%  
  summarise(
    TotalPrescriptions = n(), across(c(PracticeListSize, SIMD2020V2CADecile, SIMD2020V2CAQuintile, CA, DataZone), first),
    PrescriptionRate_byGP = (TotalPrescriptions / PracticeListSize) * 1000,     
    .groups = "drop"
  )

summary(TotalPrescriptions_byGP$PrescriptionRate_byGP)
summary(TotalPrescriptions_byGP$PracticeListSize)


```


```{r}
#data visualisation

TotalPrescriptions_byGP2 <- TotalPrescriptions_byGP %>%
  mutate(City = case_when(
    CA == "S12000036" ~ "Edinburgh",
    CA == "S12000033" ~ "Aberdeen",
    CA == "S12000042" ~ "Dundee",
    CA == "S12000049" ~ "Glasgow",
  ))

library(ggplot2)
ggplot(TotalPrescriptions_byGP2, 
       aes(x = as.factor(SIMD2020V2CADecile), y = PrescriptionRate_byGP)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.3, width = 0.2) +
  scale_y_log10() +
  facet_wrap(~ City) +
  labs(
    x = "SIMD Decile", 
    y = "Prescription Rate per 1000 people (log scale)"
  ) +
  theme_minimal()

```
x-axis: represents the level of deprivation for the data zone in which each GP practice is located, relative to other areas within the same council. 
y-axis: the number of antidepressant prescriptions issued by a GP practice per 1000 of its registered patients, plotted on a log scale. 
The data are presented in four panels, one for each of Scotland's major cities, which intended to highlight the distribution of prescription rates within each city using boxplot and to enable comparison of deprivation-prescription relationships across cities. 
Each point represents a single GP practice. 

Next Steps: 
1. visual analysis.
2. statistical validation use Spearman correlation test to test the deprivation-prescribing relationship and test the assumptions. + result table 
3. calculate effect sizes. 
4. create supporting visualisations such as violin plot to provide a clear sense of density distribution. 
