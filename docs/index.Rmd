---
title: "Assessment"
output: html_document
toc: true
toc_float: true
date: "2025-10-31"
---
## "Is there a relationship between antidepressant prescriptions and SIMD deprivation level in Scotland’s major cities (Glasgow, Edinburgh, Dundee and Aberdeen)?"


### Introduction

*Mental health* is a fundamental determinant of individual and societal well-being, closely intertwined with socioeconomic conditions. Economic pressures, such as living in resource-limited or relatively deprived communities, can potentially exacerbate mental health burdens. Regional disparities in public provision or the high cost of private care may lead individuals to rely primarily on pharmacological interventions rather than psychological therapies, reflecting limited access to specialized mental health services, which is a phenomenon that could be captured by exploring antidepressant prescription rates across different deprivation levels. In this analysis, the **relationship between SIMD deprivation levels and antidepressant prescribing patterns across Scotland's four major cities, Edinburgh, Glasgow, Dundee, and Aberdeen**, is examined by linking **community prescription data by prescriber location from NHS Scotland**, published through the *Scottish Health and Social Care Open Data Service*, with **area-level deprivation scores** from the *Scottish Index of Multiple Deprivation (SIMD)*, and aming to provide insights into how mental health reflects and shapes socioeconomic and healthcare inequalities. 


### Methods

This analysis followed a sequential workflow. Firstly, prescription data from August 2023 to July 2025 were imported and filtered to include antidepressant medications based on British National Formulary (BNF) codes. The data were then combined into a single dataset containing relevant variables and adjusted to account for seasonal variation and minimize short-term monthly fluctuations, thereby enhancing the robustness of the findings. Followingly, data wrangling and integration were performed to combine prescription records with geographic and socioeconomic context. *Prescription data* were linked to GP practice–level *geographic information* using GP practice codes and merged with *deprivation measures* at the data-zone level for Scotland’s four major cities. In the *combined* dataset, some data zones do not contain a physical GP practice because SIMD data zones are designed to represent approximate population sizes (~500-1000 people per data zone) rather than the location of healthcare services. Therefore, the combined dataset was filtered to retain only observations with a valid GP practice identifier (GPPractice). Subsequently, the most up-to-date *population estimates (2022)* at the data zone level were incorporated to calculate population-standardised prescription rates, which were then aggregated by data zone and grouped by region and SIMD country-level quintile. The antidepressant prescribing rates were calculated as prescriptions per 1,000 population per year, accounting for the two-year study period. Subsequently, statistical analysis was undertaken using linear regression to examine the reltionship between SIMD deprivation level and antidepressant prescribing rates, with city included as a factor and interaction terms used to assess whether deprivation–prescribing relationships differed by city. Estimated marginal means (EMMs) were computed to summarise adjusted prescribing rates across deprivation quintiles, and pairwise comparisons were used to evaluate differences between SIMD levels. Finally, results were visualized using column plots with confidence intervals to illustrate differences in antidepressant prescribing across deprivation levels, and a formatted summary table was generated to quantitatively support the visual representation. 


### Results

A general linear model was employed to estimate the overall effects of deprivation on antidepressant prescribing rates, including potential interactions between deprivation and city. By examining the model coefficients, the analysis investigates variation between groups by comparing each SIMD quintile to the reference quintile within each city, in order to assess how prescription differences between SIMD quintiles vary across cities. Macroscopically, the model evaluates whether deprivation, city, or their interaction exert an overall effect on antidepressant prescribing rates across all cities, using 2-way ANOVA. The null hypotheses are assumed that firstly, the antidepressant prescribing rates are equal across SIMD deprivation levels in Scotland's major cities; secondly, the antidepressant prescribing rates are the same between cities; thirdly, there is no significant interaction between SIMD quintile and city. The 2-way ANOVA GLM provides a strong evidence that antidepressant prescribing rates significantly differs across SIMD deprivation levels (F = 7.8311, df = 4, p = 8.710 x 10^{-6}) and between the 4 major cities (F = 22.5658, df = 3, p = 3.173 x 10^{-12}). Contrarily, the pattern of change across SIMD quintiles is considered roughly similar in all cities (F = 1.2168, df = 12, p = 0.2758), although the overall prescribing rates can still be higher or lower in one city compared to another. Specifically, the highest antidepressant prescribing rates were observed in the most deprived areas (SIMD quintile 1; mean ± SE: 25496 ± 2430; 95% CI: 20697, 30295), whereas the lowest rates were found in the least deprived areas (SIMD quintile 5; mean ± SE: 11905 ± 3090; 95% CI: 5807, 18003). Although a general decreasing socioeconomic gradient might be expected, prescribing rates in the middle deprivation quintiles are not proportional to each other, where areas in quintile 4 possesses higher prescription rates (mean ± SE:22771 ± 3690; 95% CI: 15475, 30067), compared to areas in quintile 2 (mean ± SE:17534 ± 2440; 95% CI: 12706, 22362) and quintile 3 (mean ± SE: 15668 ± 2070; 11576, 19761). 


## Discussion & Conclusion
This analysis highlights a close link between socioeconomic deprivation and mental health treatment burden. Prescribing rates for antidepressants varied across deprivation levels and between cities, pointing to the influence of socioeconomic inequalities on mental health. Although prescribing rates differed between cities, the overall pattern across SIMD deprivation quintiles was broadly similar, which may be attributed to variability within specific SIMD quintiles, including the presence of outliers, uneven distributions of data zones across deprivation levels, or wider interquartile ranges within certain cities at specific SIMD quintile levels. Taken together, these findings support the conclusion that SIMD deprivation level contributes to mental health burden. However, as deprivation captures multiple dimensions of reduced quality of life, such as income, employment, education, and health, future research could explore whether higher prescribing rates in more deprived areas primarily reflect a greater prevalence of mental health conditions, or whether they indicate increased reliance on pharmacological treatment due to limited access to non-pharmacological mental health support. Differences in antidepressant prescribing may therefore signal inequalities not only in mental health burden, but also in the availability and type of mental health care across socioeconomic contexts. 


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, fig.show='hold', code_download = TRUE)
knitr::opts_chunk$set(fig.width = 8, fig.height = 6.5)

library(tidyverse)
library(here)
library(ggplot2)
library(emmeans)
library(gt)
```


```{r}
links <- read_csv(here("file_links.csv")) %>% 
  select(link) %>% 
  pull()

joined_data_24 <- links %>% 
  map(~ read_csv (.x) %>% 
        select(GPPractice, BNFItemCode, NumberOfPaidItems, PaidDateMonth) %>% 
        filter(str_detect(BNFItemCode, "^04030[1-4]"))) %>% 
  list_rbind()
```


```{r}
GeoInfo <- read_csv(here("data", "GPPracticesOct.csv")) %>%  
  select(PracticeCode, PracticeListSize, DataZone, GPCluster)

GeoInfo_24 <- joined_data_24 %>% 
  left_join(GeoInfo, by = c("GPPractice" = "PracticeCode"))

SIMD <- read_csv(here("data", "SIMD2020v2.csv")) %>% 
  select(DataZone, CA, SIMD2020V2Rank, SIMD2020V2CountryQuintile, SIMD2020V2CAQuintile) 

CA <- read_csv(here("data", "CAarea.csv")) %>% 
  select(CA, CAName) %>% 
  filter(str_to_lower(CAName) %in% str_to_lower(c("city of Edinburgh", "Aberdeen city", "Glasgow city", "Dundee city")))

SIMD_CA <- left_join(CA, SIMD, by = c("CA" = "CA"))

Combined_data <- left_join(SIMD_CA, GeoInfo_24, by = c("DataZone" = "DataZone"))

Combined_data %>% 
  filter(is.na(GPPractice)) %>%
  select(DataZone) %>%
  distinct()

Combined_data_clean <- Combined_data %>% 
  filter(!is.na(GPPractice))

Population <- read_csv(here("data", "DataZonePopulationEstimate2021.csv")) %>% 
  filter(Sex == "All", Year == "2022") %>% 
  select(DataZone, TotalPopulation = AllAges)

Final_data <- Combined_data_clean %>% 
  left_join(Population, by = c("DataZone" = "DataZone"))

```


```{r}
analysis_data <- Final_data %>% 
  group_by(CAName, SIMD2020V2CountryQuintile, DataZone) %>% 
  summarise(total_prescriptions = sum(NumberOfPaidItems, na.rm = TRUE), 
    population = first(TotalPopulation),
    .groups = "drop") %>% 
  mutate(prescriptions_per1000_perYear = ((total_prescriptions / population) * 1000) / 2) %>% 
  filter(!is.na(DataZone)) 

mean_data <- analysis_data %>% 
  group_by(CAName, SIMD2020V2CountryQuintile) %>% 
  summarise(mean_rate = mean(prescriptions_per1000_perYear, na.rm = TRUE))
```


```{r}
ggplot(analysis_data, 
       aes(x = factor(SIMD2020V2CountryQuintile), y = prescriptions_per1000_perYear, fill = factor(SIMD2020V2CountryQuintile))) +
  geom_boxplot(alpha = 0.8) + 
  geom_jitter(width = 0.2, alpha = 0.3) +  
  facet_wrap(~ CAName) +                           
  scale_fill_manual(values= c("1" = "red", "2" = "orange", "3" = "khaki2",
                              "4" = "yellowgreen", "5" = "limegreen"),
                    guide = "none") +
  labs(x = "SIMD Quintile (1 = most deprived)",
       y = "Antidepressant prescriptions per 1,000 people per year", 
       title = "Distribution of prescriptions by SIMD quintile and city") +
  theme_bw() +
  theme(axis.line = element_line(size = 0.6, colour = "black"),
        panel.grid.major = element_blank(),
        plot.title = element_text(hjust = 0.5))
```


```{r, fig.show="hide", echo=TRUE}
stat_lm <- lm(prescriptions_per1000_perYear ~ factor(SIMD2020V2CountryQuintile) * CAName, data = analysis_data)
plot(stat_lm)
summary(stat_lm) 
anova(stat_lm) 

stat_emm <- emmeans(stat_lm, ~SIMD2020V2CountryQuintile)
stat_emm
```


```{r}
stat_emm_plot <- as.data.frame(stat_emm)

ggplot(stat_emm_plot, aes(x = factor(SIMD2020V2CountryQuintile), y = emmean, fill = factor(SIMD2020V2CountryQuintile))) +
  geom_col(width = 0.7) +  
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2, color = "black") +
  geom_point(size = 3, color = "darkred") +
  scale_fill_manual(
    values = c("1" = "red", "2" = "orange", "3" = "khaki2", "4" = "yellowgreen", "5" = "limegreen"), guide = "none") +
  labs(title = "Antidepressant Prescriptions by SIMD Quintile", 
       x = "SIMD Quintile (1 = Most Deprived)", 
       y = "Estimated Marginal Mean (Prescription rate across cities)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
gt_table <- stat_emm_plot %>% 
  gt() %>% 
  tab_header(title = "Estimated Marginal Means of Antidepressant Prescriptions by SIMD Quintile across 4 Major Cities", 
             subtitle = "Data obtained from Public Health Scotland") %>% 
  cols_label(SIMD2020V2CountryQuintile = "SIMD Quintile (Country-level)", emmean = "Emmeans", SE = "Standard Error", df = "Degree of Freedom", lower.CL = "Lower 95% CI", upper.CL = "Upper 95% CI") %>%
  cols_align(align = "center", columns = everything()) %>% 
  fmt_number(columns = vars(emmean, SE, lower.CL, upper.CL), decimals = 1) %>% 
  tab_style(style = cell_fill(color = "lightgrey"), locations = cells_column_labels(everything())) %>% 
  tab_source_note(source_note = "N.B. Estimated marginal means (emmeans) calculated as prescription rate per 1,000 population per year, averaged across cities.")
gt_table
```































