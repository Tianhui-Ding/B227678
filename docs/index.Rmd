---
title: "Assessment"
output: html_document
date: "2025-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:





Research Question: "Is there a relationship between antidepressant prescriptions and SIMD deprivation level in Scotlandâ€™s major cities (Glasgow, Edinburgh, Dundee and Aberdeen)?" 

```{r}
#merge 12 "Data by Prescriber Locations" files (August 2024 - July 2025) into one single file and only keeps columns & drug type (antidepressants) relative to the research question. 
library(tidyverse)
library(dplyr)

file_list <- list.files(path = here::here("data"),
                        pattern = "^2024|2025",
                        full.names = TRUE)

combined_PrescriberData <- map_dfr(file_list, ~read.csv(.x)  %>%
                                    select(HBT, GPPractice, BNFItemCode, PaidDateMonth)) %>% 
                                    filter(str_detect(BNFItemCode, "^04030[1-4]"))

sum(is.na(combined_PrescriberData)) ##for check

#only focus on Edinburgh in aid of the most up-t-date GP Practice Location data (regardless of month because Practice List Sizes are not considered)

GPPractice_location <- read_csv(here::here("data", "GPLocation.csv")) %>% 
  select(PracticeCode, PracticeListSize, HB, DataZone) 
 
GPPracticeLocation_with_CombinedPrescriber <- combined_PrescriberData %>% 
  left_join(GPPractice_location, by = c("GPPractice" = "PracticeCode"))



#combine with SIMD file
SIMD <- read_csv(here::here("data", "SIMD2020v2.csv")) %>% 
  select(DataZone, HB, CA, SIMD2020V2Rank, SIMD2020V2CADecile, SIMD2020V2CAQuintile)

GPPracticeLocation_CombinedPrescriber_SIMD <- GPPracticeLocation_with_CombinedPrescriber %>% 
  left_join(SIMD, by = c("DataZone" = "DataZone", "HB" = "HB")) %>% 
   filter(CA %in% c("S12000036", "S12000033", "S12000042", "S12000049"))


#combine with population file
PopulationEstimates <- read_csv(here::here("data", "PopulationEstimate.csv"))%>% 
  select(DataZone, Year, Sex, TotalPopulation = AllAges) %>% 
  filter(Year == 2022, Sex == "All") %>% 
  select(-Year, -Sex)

GPPracticeLocation_CombinedPrescriber_SIMD_Population <- GPPracticeLocation_CombinedPrescriber_SIMD %>% 
  left_join(PopulationEstimates, by = c("DataZone" = "DataZone"))
``` 



```{r}

TotalPrescriptions_byGP <- GPPracticeLocation_CombinedPrescriber_SIMD_Population %>%
  group_by(GPPractice) %>% ##treat all rows from same GP as one group, every calculation in summarise will happen within each GP separately. 
  summarise(
    TotalPrescriptions = n(), across(c(PracticeListSize, SIMD2020V2CADecile, SIMD2020V2CAQuintile, CA), first),
    PrescriptionRate_byGP = (TotalPrescriptions / PracticeListSize) * 1000,     
    .groups = "drop"
  )

summary(TotalPrescriptions_byGP$PrescriptionRate_byGP)
summary(TotalPrescriptions_byGP$PracticeListSize)


```


```{r}

library(dplyr)
TotalPrescriptions_byGP2 <- TotalPrescriptions_byGP %>%
  mutate(City = case_when(
    CA == "S12000036" ~ "Edinburgh",
    CA == "S12000033" ~ "Aberdeen",
    CA == "S12000042" ~ "Dundee",
    CA == "S12000049" ~ "Glasgow",
  ))

ggplot(TotalPrescriptions_byGP2, 
       aes(x = SIMD2020V2CADecile, y = PrescriptionRate_byGP)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red", linewidth = 0.5) +
  scale_y_log10() +
  facet_wrap(~ City) +
  labs(
    x = "SIMD Decile",
    y = "Prescription Rate per 1000 (log scale)"
  ) +
  theme_minimal()





```

